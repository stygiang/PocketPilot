generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Cadence {
  WEEKLY
  BIWEEKLY
  MONTHLY
  CUSTOM
}

enum SubscriptionStatus {
  FREE
  PRO
  PAST_DUE
  CANCELED
}

enum AccountType {
  CREDIT_CARD
  DEBIT
  CHECKING
  SAVINGS
  INVESTMENT
  LOAN
  CASH
  OTHER
}

enum TrackingMode {
  MANUAL
  AUTOMATIC
}

model User {
  id                 String              @id @default(cuid())
  email              String              @unique
  passwordHash       String
  createdAt          DateTime            @default(now())
  settings           Settings?
  balanceSnapshots   BalanceSnapshot[]
  incomeSources      IncomeSource[]
  bills              Bill[]
  expenses           Expense[]
  subscription       Subscription?
  accounts           Account[]
  transactions       Transaction[]
}

model Settings {
  id                           String   @id @default(cuid())
  userId                       String   @unique
  timezone                     String   @default("UTC")
  plannedSavingsCentsPerPaycheck Int    @default(0)
  user                         User     @relation(fields: [userId], references: [id])
}

model BalanceSnapshot {
  id           String   @id @default(cuid())
  userId       String
  balanceCents Int
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
}

model IncomeSource {
  id           String   @id @default(cuid())
  userId       String
  name         String
  amountCents  Int
  cadence      Cadence
  nextPayDate  DateTime
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Bill {
  id           String   @id @default(cuid())
  userId       String
  name         String
  amountCents  Int
  cadence      Cadence
  dueDayOfMonth Int?
  nextDueDate  DateTime?
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Expense {
  id          String   @id @default(cuid())
  userId      String
  amountCents Int
  date        DateTime
  category    String?
  note        String?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId, date])
}

model Subscription {
  id                     String             @id @default(cuid())
  userId                 String             @unique
  stripeCustomerId       String?
  stripeSubscriptionId   String?
  status                 SubscriptionStatus @default(FREE)
  currentPeriodEnd       DateTime?
  user                   User               @relation(fields: [userId], references: [id])
}

model Account {
  id                String        @id @default(cuid())
  userId            String
  name              String        // e.g., "Chase Sapphire", "Fidelity Brokerage"
  type              AccountType
  trackingMode      TrackingMode  @default(MANUAL)

  // Institution details
  institutionName   String?       // e.g., "Chase", "Bank of America"
  institutionLogo   String?       // URL to bank logo

  // Card/Account details
  lastFourDigits    String?       // Last 4 digits for display
  accountNumber     String?       // Encrypted full account number (for auto-tracking)
  routingNumber     String?       // For bank accounts

  // Balance tracking
  currentBalanceCents    Int      @default(0)
  availableBalanceCents  Int?     // For credit cards: available credit
  creditLimitCents       Int?     // For credit cards: total credit limit
  interestRatePercent    Float?   // APR for credit cards/loans

  // For investment accounts
  totalValueCents        Int?     // Total portfolio value
  totalGainLossCents     Int?     // Overall gain/loss

  // Metadata
  color             String?       // Custom color for the card
  isHidden          Boolean       @default(false)
  isPrimary         Boolean       @default(false)

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  user              User          @relation(fields: [userId], references: [id])
  transactions      Transaction[]

  @@index([userId])
  @@index([userId, type])
}

model Transaction {
  id              String    @id @default(cuid())
  userId          String
  accountId       String

  amountCents     Int
  description     String
  merchantName    String?
  category        String?

  date            DateTime
  isRecurring     Boolean   @default(false)
  isPending       Boolean   @default(false)
  needsReview     Boolean   @default(false)

  // For categorization
  tags            String[]  @default([])
  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User      @relation(fields: [userId], references: [id])
  account         Account   @relation(fields: [accountId], references: [id])

  @@index([userId, date])
  @@index([accountId, date])
  @@index([userId, category])
}
